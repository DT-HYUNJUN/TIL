# IPC

## IPC란

IPC는 서로 다른 프로세스 끼리 데이터를 주고받는 것이다.

IPC를 위해서는 기본적으로 공유 메모리와 공유 메모리에 대한 상호 배제적 접근을 위한 동기화 기법이 요구된다.

OS에 따라 다양한 형태의 IPC기법이 지원되고 있다.

모든 프로세스는 서로 다른 사용자 영역을 가지고 있지만 OS 영역은 공유하고 있음을 유의해야 한다.

따라서 IPC를 위한 공유 메모리를 사용자 영역 혹은 OS 영역을 사용할 수 있다.

## IPC 기법

리눅스에서 제공하는 대표적인 IPC 기법은 다음과 같다.

- 파이프 (OS)
- 메시지 큐 (OS)
- 공유 메모리 (사용자)
- 세마포어

파이프와 메시지 큐 기법은 OS 영역을 공유 메모리로 사용하기에 별도의 동기화 기법이 요구되지 않지만, 공유 메모리 기법에서는 사용자 영역의 공유 메모리 접근에 대한 동기화를 위한 추가적인 기능이 요구된다.

### **파이프**

리눅스에서 파이프는 파일 시스템에서 제공하는 파일의 일종으로써 `일반 파일`처럼 취급된다.

파이프는 개념적으로 두 프로세스 사이에서 하나의 파이프를 공유하면서 데이터를 FIFO 방식으로 데이터를 주고받는다.

즉 한 프로세스는 파이프에서 데이터를 쓰고, 다른 프로세스는 파이프로부터 데이터를 읽어가는 단반향 통신이다. (양방향 통신을 위해서는 두 개의 파이프가 필요하다.)

### **메시지 큐**

메시지 큐는 커널 내부에 메시지 큐를 생성하고 이를 공유함으로써 데이터를 주고받는 IPC 기법이다.

메시지 큐를 통한 IPC 기법의 기본적인 과정은 다음과 같다.

1. 공유 메모리 확보: msgget()  함수를 이용하여 메시지 큐를 생성한다.

```c
msgqid = msgget(key, msgflg);
```

2. 공유 메모리 사용: msgrcv(), msgsnd() 함수를 이용하여 데이터를 송수신한다.

```c
msgsnd(msgqid, *msgp, msgsz, msgflg);
msgrcv(msgqid, *msgp, msgsz, msgty, msgflg);
```

3. 공유 메모리 삭제: msgctl() 함수를 이용하여 메시지 큐를 삭제한다.

```c
msgctl(msgqid, IPC_RMID, 0);
```

### **공유 메모리**

공유 메모리는 사용자 영역에 공유 메모리를 생성하고 이를 공유함으로써 데이터를 주고받는 IPC 기법이다.

공유 메모리는 shmget() 시스템 호출에 의해 생성하고 shmctl() 시스템 호출에 의해 제거된다.

생성된 공유 메모리는 shmat(), shmdt()에 의해 주소공간에 연결, 제거된다.

1. 공유 메모리 확보: 사용자 영역에 공유 메모리를 생성한다.

```c
shmid = shmget(key, size, shmflg);
/* key 값에 해당한 size 크기의 공유 메모리 생성 */
```

2. 공유 메모리 사용: shmat() 함수를 이용하여 공유 메모리의 주소를 프로세스의 변수(local)에 연결한 후 변수에서 직접 읽기/쓰기 한다.

```c
local = shmat(shmid, *shmaddr, shmflg);
/* shmid 공유 메모리를 프로세스의 변수(local)에 연결 */
```

3. 공유 메모리 삭제
   1. shmdt() 함수를 이용하여 공유 메모리 주소를 프로세스의 변수로부터 분리한다.
   ```c
   shmdt(local);
   /* 공유 메모리를 local로부터 분리 */
   ```

   2. shmctl() 함수를 이용하여 공유 메로리를 삭제한다.
   ```c
   shmctl(shmid, IPC_RMID, 0)
   /* 공유 메모리 삭제 */
   ```